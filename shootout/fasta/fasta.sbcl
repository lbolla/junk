;; The Computer Language Benchmarks Game
;; http://shootout.alioth.debian.org/
;;
;; Contributed by Lorenzo Bolla

(declaim (optimize (speed 3) (debug 0) (safety 0)))

(declaim (fixnum +line-length+ +im+))
(defconstant +line-length+ 60)
(defconstant +im+ 139968)

(declaim (base-string *alu*))
(defparameter *alu* (concatenate 'base-string
								 "GGCCGGGCGCGGTGGCTCACGCCTGTAATCCCAGCACTTTGG"
								 "GAGGCCGAGGCGGGCGGATCACCTGAGGTCAGGAGTTCGAGA"
								 "CCAGCCTGGCCAACATGGTGAAACCCCGTCTCTACTAAAAAT"
								 "ACAAAAATTAGCCGGGCGTGGTGGCGCGCGCCTGTAATCCCA"
								 "GCTACTCGGGAGGCTGAGGCAGGAGAATCGCTTGAACCCGGG"
								 "AGGCGGAGGTTGCAGTGAGCCGAGATCGCGCCACTGCACTCC"
								 "AGCCTGGGCGACAGAGCGAGACTCCGTCTCAAAAA"))

(defun cumsum (lst)
  (let ((c 0.0))
	(declare (type single-float c))
	(mapcar #'(lambda (x) 
				(declare (type single-float x)
						 (values fixnum))
				(incf c x) 
				(the fixnum (ceiling (* +im+ c)))) ; FIXME 
			lst)))

(defun make-cprob (probs)
  (make-array (length probs)
			   :element-type 'fixnum
			   :initial-contents (cumsum probs)))

(defparameter *amino-acids-syms* "acgtBDHKMNRSVWY")
(defparameter *amino-acids-cprobs* 
  (make-cprob '(0.27 0.12 0.12 0.27 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02)))

(defparameter *homo-sapiens-syms* "acgt")
(defparameter *homo-sapiens-cprobs* 
  (make-cprob '(0.3029549426680 0.1979883004921 0.1975473066391 0.3015094502008)))

(let ((r 42)
	  (ia 3877)
	  (ic 29573))
  (declare (type fixnum r ia ic))
  (defun reset-random () (setf r (the fixnum 42)))
  (declaim (inline next-random))
  (defun next-random ()
	(declare (values fixnum))
	(setf r (mod (+ (the (integer 0 542655936) (* r ia)) ic) +im+))))

(defun find-amino-acid (amino-acids-syms amino-acids-cprobs p)
  (declare (type (simple-array fixnum (*)) amino-acids-cprobs)
		   (type simple-string amino-acids-syms)
		   (type fixnum p))
  (let* ((i 0)
		 (j (length amino-acids-syms)))
	(declare (type fixnum i j))
	(loop
	  (when (<= j i) 
		(return (aref amino-acids-syms i)))
	  (let* ((mid (ash (+ i j) -1))
			 (c (aref amino-acids-cprobs mid)))
		(cond ((< p c)
			   (setf j mid))
			  (t
				(setf i (1+ mid))))))))

(declaim (inline output-line flush))
(defun output-line (line &key (start 0) (end nil))
  (write-line line *standard-output* :start start :end end))
(defun flush ()
  (finish-output *standard-output*))

(defun randomize (amino-acids-syms amino-acids-cprobs title n)
  (declare (type fixnum n))
  (output-line title)
  (let ((buf (make-string +line-length+))
		(j -1))
	(declare (type simple-string buf)
			 (type fixnum j))
	(dotimes (i n)
	  (declare (type fixnum i))
	  (when (= (incf j) +line-length+)
		(output-line buf)
		(setf j 0))
	  (setf (aref buf j) (find-amino-acid amino-acids-syms amino-acids-cprobs (next-random))))
	(output-line buf :start 0 :end (1+ j))))

(defun repeat (alu title n)
  (declare (type base-string alu) 
		   (type fixnum n))
  (let ((len (length alu))
		(buf (concatenate 'base-string 
						  alu 
						  (subseq alu 0 +line-length+))))
	(declare (type fixnum len) 
			 (type base-string buf))
	(output-line title)
	(do* ((pos-start 0 (mod pos-end len))
		  (m n (- m bytes))
		  (bytes (min n +line-length+) (min m +line-length+))
		  (pos-end (+ pos-start bytes) (+ pos-start bytes)))
	  ((<= m 0) (flush))
	  (declare (type fixnum pos-start pos-end m bytes))
	  (output-line buf :start pos-start :end pos-end))))

(defun main (&optional in-n)
  (let ((n (or in-n
			   (ignore-errors
				 (parse-integer (car (last #+sbcl sb-ext:*posix-argv*
										   #+cmu  extensions:*command-line-strings*
										   #+gcl  si::*command-args*
										   #+clisp nil))))
			   1000)))
	(declare (fixnum n))
	(reset-random)
	(repeat *alu* ">ONE Homo sapiens alu" (the fixnum (* n 2)))
	(randomize *amino-acids-syms* *amino-acids-cprobs* ">TWO IUB ambiguity codes" (the fixnum (* n 3)))
	(randomize *homo-sapiens-syms* *homo-sapiens-cprobs* ">THREE Homo sapiens frequency" (the fixnum (* n 5)))))
